<!doctype html>
<html>
  <head>
    <link rel="stylesheet" href="katex.min.css" />
    <script src="katex.min.js"></script>
    <script src="tex2typst.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      html,
      body {
        width: 100%;
        height: 100%;
        background: white;
        overflow: hidden;
      }
      body {
        display: flex;
        flex-direction: column;
        padding: 12px;
        -webkit-user-select: none;
        user-select: none;
      }
      .equation-area {
        flex: 1;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 0;
      }
      .container {
        display: flex;
        justify-content: center;
        align-items: center;
        transform-origin: center center;
        opacity: 0;
        transition: opacity 0.1s ease-in;
      }
      .katex-display {
        margin: 0 !important;
      }
      .katex-display > .katex {
        white-space: nowrap;
      }
      .katex {
        font-family:
          "New Computer Modern Math", "New Computer Modern",
          "Latin Modern Math", "KaTeX_Main", serif !important;
      }
      .copy-boxes {
        display: flex;
        flex-direction: column;
        gap: 6px;
        margin-top: 10px;
      }
      .copy-row {
        display: flex;
        align-items: center;
        height: 28px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        background: #f9fafb;
        overflow: hidden;
        cursor: pointer;
      }
      .copy-row:hover {
        border-color: #9ca3af;
      }
      .copy-row.copied {
        background: #007aff;
        border-color: #007aff;
      }
      .copy-row.copied .copy-content {
        color: white;
      }
      .copy-row.copied .copy-btn {
        border-left-color: rgba(255, 255, 255, 0.3);
        background: transparent;
      }
      .copy-row.copied .copy-btn svg {
        color: white;
      }
      .copy-row.disabled {
        opacity: 0.4;
        pointer-events: none;
        cursor: not-allowed;
      }
      .copy-content {
        flex: 1;
        padding: 0 10px;
        font-family:
          ui-monospace, SFMono-Regular, "SF Mono", Menlo, Monaco, monospace;
        font-size: 12px;
        color: #374151;
        white-space: nowrap;
        overflow-x: auto;
        overflow-y: hidden;
        line-height: 26px;
      }
      .copy-content::-webkit-scrollbar {
        display: none;
      }
      .copy-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 100%;
        border: none;
        border-left: 1px solid #d1d5db;
        background: #fff;
        cursor: pointer;
      }
      .copy-btn:hover {
        background: #f3f4f6;
      }
      .copy-btn:active {
        background: #e5e7eb;
      }
      .copy-btn svg {
        width: 14px;
        height: 14px;
        color: #6b7280;
      }
    </style>
    <script>
      function renderLatex() {
        const container = document.querySelector(".container");
        if (!container) return;

        const latex = "{{LATEX}}";
        try {
          katex.render(latex, container, {
            displayMode: true,
            throwOnError: false,
          });
        } catch (e) {
          container.textContent = "Error rendering LaTeX: " + e.message;
        }

        // Set copy box content
        document.getElementById("raw-content").textContent = latex;
        document.getElementById("inline-content").textContent =
          "$" + latex + "$";
        document.getElementById("block-content").textContent =
          "$$" + latex + "$$";

        // Convert to Typst
        const typstRow = document.querySelector('.copy-row[title*="Typst"]');
        try {
          const typst = tex2typst(latex);
          document.getElementById("typst-content").textContent =
            "$" + typst + "$";
          typstRow.classList.remove("disabled");
        } catch (e) {
          document.getElementById("typst-content").textContent =
            "conversion failed";
          typstRow.classList.add("disabled");
        }

        scaleToFit();
      }

      function scaleToFit() {
        const container = document.querySelector(".container");
        const equationArea = document.querySelector(".equation-area");
        if (!container || !equationArea) return;

        // Measure offscreen at natural size
        container.style.visibility = "hidden";
        container.style.position = "absolute";
        container.style.transform = "none";

        const maxW = equationArea.clientWidth - 48;
        const maxH = equationArea.clientHeight - 32;
        const w = container.scrollWidth;
        const h = container.scrollHeight;

        // Calculate scale and apply
        const scale = (w > 0 && h > 0) ? Math.min(1, maxW / w, maxH / h) : 1;
        container.style.transform = "scale(" + scale + ")";

        // Restore and show
        container.style.position = "";
        container.style.visibility = "";
        container.style.opacity = "1";
      }

      function copyRow(row) {
        if (row.classList.contains("disabled")) return;

        const contentEl = row.querySelector(".copy-content");
        const button = row.querySelector(".copy-btn");
        const text = contentEl.textContent;
        navigator.clipboard.writeText(text).then(() => {
          // Remove copied state from all rows
          document.querySelectorAll(".copy-row.copied").forEach((r) => {
            r.classList.remove("copied");
            r.querySelector(".copy-btn").innerHTML =
              '<svg viewBox="0 0 20 20" fill="currentColor"><path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z"/><path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z"/></svg>';
          });
          // Add copied state to clicked row
          row.classList.add("copied");
          button.innerHTML =
            '<svg viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>';
        });
      }

      window.addEventListener("DOMContentLoaded", () => {
        document.fonts.ready.then(renderLatex);
      });
    </script>
  </head>
  <body>
    <div class="equation-area">
      <div class="container"></div>
    </div>
    <div class="copy-boxes">
      <div class="copy-row" onclick="copyRow(this)" title="Copy raw LaTeX">
        <span class="copy-content" id="raw-content"></span>
        <button class="copy-btn">
          <svg viewBox="0 0 20 20" fill="currentColor">
            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
            <path
              d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z"
            />
          </svg>
        </button>
      </div>
      <div class="copy-row" onclick="copyRow(this)" title="Copy inline format">
        <span class="copy-content" id="inline-content"></span>
        <button class="copy-btn">
          <svg viewBox="0 0 20 20" fill="currentColor">
            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
            <path
              d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z"
            />
          </svg>
        </button>
      </div>
      <div class="copy-row" onclick="copyRow(this)" title="Copy block format">
        <span class="copy-content" id="block-content"></span>
        <button class="copy-btn">
          <svg viewBox="0 0 20 20" fill="currentColor">
            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
            <path
              d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z"
            />
          </svg>
        </button>
      </div>
      <div class="copy-row" onclick="copyRow(this)" title="Copy Typst format">
        <span class="copy-content" id="typst-content"></span>
        <button class="copy-btn">
          <svg viewBox="0 0 20 20" fill="currentColor">
            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
            <path
              d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z"
            />
          </svg>
        </button>
      </div>
    </div>
  </body>
</html>
