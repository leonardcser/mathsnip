# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Overview

MathSnip is a macOS menu bar application that converts mathematical equations to LaTeX and Typst formats using image recognition. It captures equation images from the screen and processes them through pluggable ML backends.

## Building and Running

### Build with Makefile
```bash
make setup                # First time: set up backend (default: texo-coreml)
make install              # Build and install to /Applications
make build                # Build only (no install)
make clean                # Clean build artifacts
make help                 # Show all commands
```

Or with a specific backend:
```bash
make BACKEND=texo setup && make install
make BACKEND=pix2tex setup && make install
```

The Makefile handles:
- Backend selection via `BACKEND` variable (texo-coreml, texo, pix2tex)
- Running appropriate setup scripts per backend (`make setup`)
- Generating `BackendConfig.swift` with selected backend
- Creating app bundle structure
- Copying assets and resources
- Bundling CoreML models (for texo-coreml backend)
- Compiling Swift code
- Installing to /Applications

### Run
Click the MathSnip menu bar icon to start snipping, or right-click for the context menu.

## Architecture

### Core Components

**AppDelegate.swift** - Main application controller
- Status bar item setup and click handling
- Snipping flow orchestration (`startSnipping()` → `handleSelection()` → `captureAndProcess()`)
- Backend abstraction and switching between Texo-CoreML, Texo, and pix2tex
- CoreML model loading and inference
- Permission checking (Accessibility, Screen Recording)
- Screenshot capture using ScreenCaptureKit with scaling and cropping

**StatusBarMenu.swift** - Dropdown menu manager
- Builds menu with version info, Snip, GitHub, and Quit items
- Closure callbacks (`onSnip`, `onGitHub`, `onQuit`) for actions

**backends/pix2tex/Pix2TexBackend.swift** - pix2tex external tool manager
- Locates pix2tex executable in common paths
- Runs inference via external process
- Parses pix2tex output format
- Setup checking and alert display

**backends/texo/TexoBackend.swift** - Texo Python backend manager
- Daemon lifecycle (start, stop, wait for ready)
- Socket-based communication with daemon
- Fallback to single-shot inference when daemon unavailable
- Setup checking and alert display

**backends/texo-coreml/TexoCoreMLBackend.swift** - CoreML backend manager
- Model loading and readiness tracking
- Wraps TexoCoreMLInference for inference
- Setup checking and alert display

**OverlayPanel.swift & OverlayView.swift** - Full-screen selection overlay
- CGEvent tap for capturing mouse/keyboard events during snipping
- Event tap requires Accessibility permission
- Coordinate conversion between CG (origin top-left) and NS (origin bottom-left) systems
- Selection visualization (semi-transparent overlay, white border, crosshair)
- Minimum selection size check (10×10 pixels)

**PreviewPanel.swift** - LaTeX/Typst preview window
- Floating panel below menu bar icon
- Uses WebKit to render math with KaTeX
- Includes tex2typst.js for format conversion between LaTeX and Typst
- Dynamically loads bundle resources to temp directory for security
- Dismisses on click outside

### Backend System

Three ML backends for equation recognition, located in `backends/` directory:

**Texo-CoreML** (`backends/texo-coreml/`, default)
- Best accuracy, uses FormulaNet model converted to CoreML
- On-device inference using Apple Neural Engine (ANE)
- Fast inference after initial model load
- Models bundled in app (`Encoder.mlpackage`, `Decoder.mlpackage`)
- Swift implementation with beam search decoding
- Setup: `cd backends/texo-coreml && ./setup.sh` (automatically exports CoreML models)
- Files: `TexoCoreMLBackend.swift`, `TexoCoreMLInference.swift`, `TexoCoreMLTokenizer.swift`, `export_coreml.py`, `setup.sh`

**Texo** (`backends/texo/`)
- Good accuracy, uses FormulaNet model via Python
- Persistent daemon for performance
- Socket-based IPC (`/tmp/mathsnip_texo.sock`)
- Non-blocking startup: daemon boots in background, waits for "READY" signal on stdout
- Falls back to single-shot inference if daemon unavailable
- Setup: `cd backends/texo && ./setup.sh`
- Files: `TexoBackend.swift`, `inference.py`, `setup.sh`

**pix2tex** (`backends/pix2tex/`)
- Lightweight, fast
- External tool: `pix2tex [image]`
- Paths searched: `~/.local/bin/pix2tex`, `/usr/local/bin/pix2tex`, `/opt/homebrew/bin/pix2tex`
- Output format: `"filepath: latex_result"` (parser extracts after colon)
- Install: `uv tool install pix2tex`
- Files: `Pix2TexBackend.swift`

Backend is set via `let activeBackend: LaTeXBackend` in BackendConfig.swift (auto-generated by Makefile)

**Note:** The backends are ordered by recommendation: Texo-CoreML (best accuracy, on-device), Texo (good accuracy, Python daemon), pix2tex (lightweight, external tool).

### Texo Daemon Details

When `activeBackend = .texo`:
- `TexoBackend` class manages daemon lifecycle and socket communication
- App starts daemon in background on launch without blocking
- Python script `backends/texo/inference.py` runs with `--server` flag
- App waits for daemon readiness only when snipping (max 120s timeout)
- Socket connection sends image path, receives LaTeX
- Automatic cleanup of stale socket/PID files on restart
- Falls back to single-shot inference if daemon unavailable

### CoreML Backend Details

When `activeBackend = .texoCoreml`:
- Models loaded on app launch using `TexoCoreMLInference` class
- Encoder processes image (384×384 grayscale, normalized)
- Image preprocessing: margin cropping, aspect-ratio preserving resize with padding
- Decoder uses beam search (width=4, max length=512) for better accuracy
- Uses `TexoCoreMLTokenizer` with embedded FormulaNet vocabulary
- Inference runs on ANE/GPU/CPU based on availability
- No external dependencies at runtime (models bundled in app)

## Key Development Notes

### Threading
- Event handling in CGEvent tap runs on system event thread (must not block)
- Main UI updates dispatched to main thread via `DispatchQueue.main.async`
- Asynchronous capture/processing via Task/async-await

### Coordinate Systems
- CG coordinates: origin top-left, Y increases downward
- NS coordinates: origin bottom-left, Y increases upward
- OverlayView converts between systems in `viewPointFromScreenPoint()`
- Screenshot scaling accounts for Retina displays via `backingScaleFactor`

### Screen Capture
- Uses ScreenCaptureKit with SCScreenshotManager (macOS 14.0+)
- Captures full display, then crops to selection rect
- Scaling applied based on display backing scale factor
- Temporary PNG files cleaned up after processing

### Permissions
- Accessibility: required for event tap
- Screen Recording: required for ScreenCaptureKit
- App prompts user and opens System Settings if missing
- Note: macOS treats app in different locations as separate, requiring re-grant

### Preview Panel
- Resources (CSS, JS, fonts) embedded in app bundle
- Copies to temp cache directory on each preview for security
- KaTeX renders LaTeX, tex2typst converts to Typst
- Dismisses on any click outside via local/global event monitors

## Asset Organization

- `assets/icon.png` & `icon@2x.png` - Menu bar icons
- `assets/AppIcon.icns` - App icon
- `assets/preview.html` - Preview panel template (has `{{LATEX}}` placeholder)
- `assets/katex.min.css` & `katex.min.js` - Math rendering
- `assets/tex2typst.min.js` - LaTeX to Typst conversion
- `assets/fonts/` - KaTeX fonts

## Common Tasks

### Switch Backend
Use the Makefile with the `BACKEND` variable:
```bash
make BACKEND=texo-coreml install  # Default
make BACKEND=texo install         # Texo Python backend
make BACKEND=pix2tex install      # pix2tex
```

Or edit the `BACKEND` variable at the top of the `Makefile` to change the default.

### Add New Backend
1. Create backend directory in `backends/` (e.g., `backends/my-backend/`)
2. Add case to `LaTeXBackend` enum in `AppDelegate.swift`
3. Add backend case to Makefile `setup` target
4. Add backend case to Makefile `build` target for `BackendConfig.swift` generation
5. Implement backend check in `startSnipping()` in `AppDelegate.swift`
6. Implement run function and call from `captureAndProcess()` in `AppDelegate.swift`
7. Add permission/setup checks and error alerts
8. Add setup script in backend directory

### Setup Backends
**Texo-CoreML**: `cd backends/texo-coreml && ./setup.sh`
- Automatically exports CoreML models to `../../models/` directory
- Models are bundled into the app during build

**Texo**: `cd backends/texo && ./setup.sh`

**pix2tex**: `uv tool install pix2tex`

### Modify Overlay Appearance
Edit `OverlayView.draw()` method (OverlayPanel.swift:249)
- Colors, transparency, border style
- Crosshair rendering

### Update Preview Format
Edit `assets/preview.html` template and ensure resources are copied in `PreviewPanel.showBelow()` (PreviewPanel.swift:92)

## Dependencies

- **macOS SDK**: Cocoa, ScreenCaptureKit, WebKit, CoreML, ApplicationServices
- **Swift**: No external package manager (single-file compilation)
- **Backends**:
  - Texo-CoreML: CoreML export via Python (`backends/texo-coreml/setup.sh` - includes model export)
  - Texo: Python backend with setup script (`backends/texo/setup.sh`)
  - pix2tex: External Python package (`uv tool install pix2tex`)

## File Organization

```
mathsnip/
├── backends/
│   ├── pix2tex/              # pix2tex external tool backend
│   │   └── Pix2TexBackend.swift     # External tool inference
│   ├── texo/                 # Texo Python backend
│   │   ├── TexoBackend.swift        # Daemon lifecycle and socket-based inference
│   │   ├── inference.py             # Inference script with daemon mode
│   │   └── setup.sh                 # Setup script (clones Texo, downloads model)
│   └── texo-coreml/          # CoreML backend
│       ├── TexoCoreMLBackend.swift     # Backend manager (model loading, alerts)
│       ├── TexoCoreMLInference.swift   # CoreML inference engine with beam search
│       ├── TexoCoreMLTokenizer.swift   # Tokenizer with embedded vocab
│       ├── export_coreml.py            # Model export script
│       ├── setup.sh                    # Setup script (clones Texo, downloads model)
│       ├── pyproject.toml              # Python dependencies
│       └── .gitignore                  # Ignores .venv/, Texo/, model_cache/
├── assets/                   # App resources (icons, preview template, KaTeX)
├── AppDelegate.swift         # Main app controller (status bar, snipping flow)
├── StatusBarMenu.swift       # Dropdown menu (Snip, GitHub, Quit)
├── OverlayPanel.swift        # Selection overlay
├── PreviewPanel.swift        # LaTeX preview window
├── main.swift                # Entry point
├── Makefile                  # Build system
└── CLAUDE.md                 # This file
```

## License

MIT except `backends/texo/inference.py` which is AGPL-3.0 (imports Texo)
